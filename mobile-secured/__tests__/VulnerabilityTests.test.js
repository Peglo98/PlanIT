import React from 'react';
import { render, fireEvent, waitFor } from '@testing-library/react-native';
import AsyncStorage from '@react-native-async-storage/async-storage';
import axios from 'axios';
import HomeScreen from '../src/screens/HomeScreen';
import LoginScreen from '../src/screens/LoginScreen';

// Mock dependencies
jest.mock('@react-native-async-storage/async-storage', () => ({
  setItem: jest.fn(),
  getItem: jest.fn(() => Promise.resolve(null)),
  removeItem: jest.fn(),
}));

jest.mock('expo-secure-store', () => ({
  setItemAsync: jest.fn(),
  getItemAsync: jest.fn(() => Promise.resolve(null)),
  deleteItemAsync: jest.fn(),
}));

jest.mock('axios');

// Mock Navigation
const mockNavigation = {
  replace: jest.fn(),
  navigate: jest.fn(),
  goBack: jest.fn(),
};

describe('Security Tests - Secure Version', () => {
  
  test('M1: No hardcoded API keys should be present', () => {
    // In secure version, API_KEY should not exist
    const config = require('../src/config');
    expect(config.API_KEY).toBeUndefined();
  });

  test('M9: Secure Storage - Credentials should NOT be stored in plain text', async () => {
    const SecureStore = require('expo-secure-store');
    axios.post.mockResolvedValue({ 
      data: { 
        token: 'test-jwt-token',
        user_id: 1, 
        username: 'testuser' 
      } 
    });

    const { getByPlaceholderText, getByText } = render(<LoginScreen navigation={mockNavigation} />);

    // Fill in credentials
    fireEvent.changeText(getByPlaceholderText('Username'), 'victim');
    fireEvent.changeText(getByPlaceholderText('Password'), 'secret123');

    // Login
    fireEvent.press(getByText('Login'));

    await waitFor(() => {
      // Check if SecureStore was used for token (not AsyncStorage for password)
      expect(SecureStore.setItemAsync).toHaveBeenCalled();
      // Password should NEVER be stored
      expect(AsyncStorage.setItem).not.toHaveBeenCalledWith('password', expect.anything());
    });
  });

  test('M3: Authorization - User should only see their own tasks', async () => {
    axios.get.mockResolvedValue({ data: [] });
    const SecureStore = require('expo-secure-store');
    SecureStore.getItemAsync.mockResolvedValue('test-token');

    const { getByText } = render(<HomeScreen navigation={mockNavigation} />);

    await waitFor(() => {
      // Verify that axios was called without user_id parameter
      // Backend should use JWT token to determine user
      expect(axios.get).toHaveBeenCalledWith(
        expect.stringContaining('/tasks'),
        expect.not.objectContaining({
          params: expect.objectContaining({ user_id: expect.anything() })
        })
      );
    });
  });
});
